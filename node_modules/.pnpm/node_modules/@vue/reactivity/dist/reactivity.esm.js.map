{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["import { Link } from \"./system\"\r\n\r\nexport let activeSub\r\n\r\nexport class ReactiveEffect {\r\n  constructor(public fn) { }\r\n\r\n  deps: Link | undefined\r\n  depsTail: Link | undefined\r\n  run() {\r\n\r\n    const perSub = activeSub\r\n    activeSub = this\r\n    this.depsTail = undefined\r\n    try {\r\n      return this.fn()\r\n    } finally {\r\n      activeSub = perSub\r\n    }\r\n    // this.fn()\r\n    // activeSub = undefined\r\n  }\r\n  notify() {\r\n    this.scheduler()\r\n  }\r\n  scheduler() {\r\n    this.run()\r\n  }\r\n}\r\nexport function effect(fn, options) {\r\n  const e = new ReactiveEffect(fn)\r\n  Object.assign(e, options)\r\n  e.run()\r\n  const runner = e.run.bind(e)\r\n  runner.effect = e\r\n  return runner\r\n}", "import { type ReactiveEffect } from './effect';\r\n\r\ninterface Dep {\r\n  subs: Link | undefined\r\n  subsTail: Link | undefined\r\n}\r\n/**\r\n * \u94FE\u8868\u8282\u70B9\r\n */\r\nexport interface Link {\r\n  sub: ReactiveEffect\r\n  nextSub: Link | undefined\r\n  perSub: Link | undefined\r\n  dep: Dep\r\n  nextDep: Link | undefined\r\n}\r\n/**\r\n * \u8BA2\u9605\u8005\u94FE\u8868\r\n * @param dep \r\n * @param sub \r\n */ export function link(dep, sub) {\r\n\r\n  const currentDep = sub.depsTail\r\n  const nextDep = currentDep === undefined ? sub.deps : currentDep.nextDep\r\n  // if (nextDep && nextDep.dep === undefined && sub.deps) {\r\n  if (nextDep && nextDep.dep === dep) {\r\n    console.log('\u76F8\u540C\u7684\u4F9D\u8D56\u9879\uFF0C\u76F4\u63A5\u590D\u7528');\r\n    return\r\n  }\r\n  // }\r\n\r\n  const newLink = { \r\n    sub,\r\n    nextSub: undefined,\r\n    perSub: undefined,\r\n    dep,\r\n    nextDep: undefined\r\n  }\r\n  // \u5C06\u94FE\u8868\u8282\u70B9\u4E0E dep \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\r\n  /**\r\n   * \u8BA2\u9605\u8005\u94FE\u8868\u5173\u7CFB\uFF0C\r\n   * 1.\u5C3E\u7ED3\u70B9\u6709\uFF0C\u90A3\u5C31\u5F80\u5C3E\u7ED3\u70B9\u540E\u9762\u52A0\r\n   * 2.\u5982\u679C\u5C3E\u7ED3\u70B9\u6CA1\u6709\uFF0C\u5219\u8868\u793A\u7B2C\u4E00\u6B21\u5173\u8054\uFF0C\u90A3\u5C31\u5F80\u5934\u8282\u70B9\u6DFB\u52A0\r\n   */\r\n  if (dep.subsTail) {\r\n    dep.subsTail.nextSub = newLink\r\n    newLink.perSub = dep.subsTail\r\n    dep.subsTail = newLink\r\n  } else {\r\n    dep.subs = newLink\r\n    dep.subsTail = newLink\r\n  }\r\n  // \u5C06\u94FE\u8868\u8282\u70B9\u4E0E sub \u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\r\n  if (sub.depsTail) {\r\n    sub.depsTail.nextDep = newLink\r\n    sub.depsTail = newLink\r\n  } else {\r\n    sub.deps = newLink\r\n    sub.depsTail = newLink\r\n  }\r\n}\r\n\r\nexport function propagate(subs) {\r\n  let link = subs\r\n  let queuedEffect = []\r\n  while (link) {\r\n    queuedEffect.push(link.sub)\r\n    link = link.nextSub\r\n  }\r\n  // \u901A\u77E5 effect \u91CD\u65B0\u6267\u884C\uFF0C\u83B7\u53D6\u5230\u6700\u65B0\u7684\u503C\r\n  queuedEffect.forEach(effect => effect.notify())\r\n}", "import { activeSub } from \"./effect\";\r\nimport { link, propagate, type Link } from './system';\r\n\r\n\r\n\r\nenum ReactiveFlags {\r\n  IS_REF = '__v_isRef'\r\n}\r\n\r\nclass RefImpl {\r\n  _value;\r\n\r\n  [ReactiveFlags.IS_REF] = true\r\n  // \u8BA2\u9605\u8005\r\n  subs: Link\r\n  subsTail: Link\r\n\r\n  constructor(value) {\r\n    this._value = value\r\n  }\r\n\r\n  get value() {\r\n    // console.log('\u88AB\u8BBF\u95EE', activeSub);\r\n    trackRef(this)\r\n    return this._value\r\n    \r\n  }\r\n  set value(newValue) {\r\n    // console.log('\u88AB\u4FEE\u6539');\r\n    this._value = newValue\r\n    triggerRef(this)\r\n  }\r\n}\r\n\r\nexport function ref(value) {\r\n  return new RefImpl(value)\r\n}\r\n\r\nexport function isRef(value) {\r\n  return !!(value && value[ReactiveFlags.IS_REF])\r\n}\r\n\r\n/**\r\n * \r\n * @param dep \u4F9D\u8D56\u6536\u96C6\r\n */\r\nexport function trackRef(dep) {\r\n  if (activeSub) link(dep, activeSub)\r\n}\r\n/**\r\n * \r\n * @param dep \u89E6\u53D1\u4F9D\u8D56\r\n */\r\nexport function triggerRef(dep) {\r\n  if (dep.subs) propagate(dep.subs)\r\n\r\n}\r\n\r\n \r\n"],
  "mappings": ";AAEO,IAAI;AAEJ,IAAM,iBAAN,MAAqB;AAAA,EAC1B,YAAmB,IAAI;AAAJ;AAAA,EAAM;AAAA,EAEzB;AAAA,EACA;AAAA,EACA,MAAM;AAEJ,UAAM,SAAS;AACf,gBAAY;AACZ,SAAK,WAAW;AAChB,QAAI;AACF,aAAO,KAAK,GAAG;AAAA,IACjB,UAAE;AACA,kBAAY;AAAA,IACd;AAAA,EAGF;AAAA,EACA,SAAS;AACP,SAAK,UAAU;AAAA,EACjB;AAAA,EACA,YAAY;AACV,SAAK,IAAI;AAAA,EACX;AACF;AACO,SAAS,OAAO,IAAI,SAAS;AAClC,QAAM,IAAI,IAAI,eAAe,EAAE;AAC/B,SAAO,OAAO,GAAG,OAAO;AACxB,IAAE,IAAI;AACN,QAAM,SAAS,EAAE,IAAI,KAAK,CAAC;AAC3B,SAAO,SAAS;AAChB,SAAO;AACT;;;AChBW,SAAS,KAAK,KAAK,KAAK;AAEjC,QAAM,aAAa,IAAI;AACvB,QAAM,UAAU,eAAe,SAAY,IAAI,OAAO,WAAW;AAEjE,MAAI,WAAW,QAAQ,QAAQ,KAAK;AAClC,YAAQ,IAAI,oEAAa;AACzB;AAAA,EACF;AAGA,QAAM,UAAU;AAAA,IACd;AAAA,IACA,SAAS;AAAA,IACT,QAAQ;AAAA,IACR;AAAA,IACA,SAAS;AAAA,EACX;AAOA,MAAI,IAAI,UAAU;AAChB,QAAI,SAAS,UAAU;AACvB,YAAQ,SAAS,IAAI;AACrB,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AAEA,MAAI,IAAI,UAAU;AAChB,QAAI,SAAS,UAAU;AACvB,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AACF;AAEO,SAAS,UAAU,MAAM;AAC9B,MAAIA,QAAO;AACX,MAAI,eAAe,CAAC;AACpB,SAAOA,OAAM;AACX,iBAAa,KAAKA,MAAK,GAAG;AAC1B,IAAAA,QAAOA,MAAK;AAAA,EACd;AAEA,eAAa,QAAQ,CAAAC,YAAUA,QAAO,OAAO,CAAC;AAChD;;;AC9DA,IAAM,UAAN,MAAc;AAAA,EACZ;AAAA,EAEA,CAAC,wBAAoB,IAAI;AAAA;AAAA,EAEzB;AAAA,EACA;AAAA,EAEA,YAAY,OAAO;AACjB,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,IAAI,QAAQ;AAEV,aAAS,IAAI;AACb,WAAO,KAAK;AAAA,EAEd;AAAA,EACA,IAAI,MAAM,UAAU;AAElB,SAAK,SAAS;AACd,eAAW,IAAI;AAAA,EACjB;AACF;AAEO,SAAS,IAAI,OAAO;AACzB,SAAO,IAAI,QAAQ,KAAK;AAC1B;AAEO,SAAS,MAAM,OAAO;AAC3B,SAAO,CAAC,EAAE,SAAS,MAAM,wBAAoB;AAC/C;AAMO,SAAS,SAAS,KAAK;AAC5B,MAAI,UAAW,MAAK,KAAK,SAAS;AACpC;AAKO,SAAS,WAAW,KAAK;AAC9B,MAAI,IAAI,KAAM,WAAU,IAAI,IAAI;AAElC;",
  "names": ["link", "effect"]
}
